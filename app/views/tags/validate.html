*{  }*

%{ n =  _name.replaceAll(/\./,"-")
def field = [:]
field['flash'] = play.mvc.Scope.Flash.current().get(_name)
field['flashArray'] = field['flash'] ? field['flash'].split(',') : []
field['error'] = play.data.validation.Validation.error(_name)
field['errorClass'] = field['error'] ? 'hasError' : ''
}%
<span id="${n}-error" class="bubble_html error ${_class}">${field.error}</span>
<script type="text/javascript">

    /** * CodaBubble extension for jQuery library * * Creates tooltips "coda bubble" style * * @author Carlo Tasca * @version 1.0 * * OPTIONS: * * @param {array} distances Distances of bubbles from their triggers  * @param {array} leftShifts Left positions of bubbles * @param {array} bubbleTimes Life times for bubbles * @param {array} hideDelays Hide delay times for bubbles * @param {array} bubbleWidths Hide delay times for bubbles * @param {string} bubbleImagesPath Path to skin for bubbles * @param {boolean} msieFix Fix for IE png rendering. Replaces pngs with gifs if true (default) * @param {boolean} msiePop If false removes bubble in IE */
    jQuery.fn.codaBubble = function(opts, response) {
        var bubble = this;
        opts = jQuery.extend({            distances : [20],            leftShifts : [30],              bubbleTimes : [400],              hideDelays : [0],              bubbleWidths : [200],              bubbleImagesPath : "",              msieFix : true,              msiePop : true        }, opts || {});
        function bubbleHtmlWrapper(bubbleHtml) {
            return '<table class="popup" style="opacity: 0; top: -60px; left: 33px; display: none;"><tr><td class="corner topleft"/><td class="top"/><td class="corner topright"/></tr><tr><td class="left"/><td class="bubble_content">' + bubbleHtml + '</td><td class="right"/></tr><tr><td class="corner bottomleft"/><td class="bottom"><img style="display:block;" width="30" height="29" alt="" /></td><td class="corner bottomright"/></tr></table>';
        }

        return jQuery(bubble).each(function (i) {
            var $bubbleHtml = $(bubbleHtmlWrapper(response));
            jQuery("[name='${_name}']").wrapAll("<span class='coda_bubble'/>");
            jQuery("[name='${_name}']").after($bubbleHtml);
            jQuery('.popup td.bottom img').attr('src', opts.bubbleImagesPath + '/bubble-tail2.png');
            if (opts.msieFix) {
                if ($.browser.msie) {
                    jQuery('.popup td.topleft').css('background-image', 'url(' + opts.bubbleImagesPath + '/bubble-1.gif)');
                    jQuery('.popup td.top').css('background-image', 'url(' + opts.bubbleImagesPath + '/bubble-2.gif)');
                    jQuery('.popup td.topright').css('background-image', 'url(' + opts.bubbleImagesPath + '/bubble-3.gif)');
                    jQuery('.popup td.left').css('background-image', 'url(' + opts.bubbleImagesPath + '/bubble-4.gif)');
                    jQuery('.popup td.right').css('background-image', 'url(' + opts.bubbleImagesPath + '/bubble-5.gif)');
                    jQuery('.popup td.bottomleft').css('background-image', 'url(' + opts.bubbleImagesPath + '/bubble-6.gif)');
                    jQuery('.popup td.bottom').css('background-image', 'url(' + opts.bubbleImagesPath + '/bubble-7.gif)');
                    jQuery('.popup td.bottomright').css('background-image', 'url(' + opts.bubbleImagesPath + '/bubble-8.gif)');
                    jQuery('.popup td.bottom img').attr('src', opts.bubbleImagesPath + '/bubble-tail2.gif');
                }
            }
            var distance = opts.distances[i];
            var time = opts.bubbleTimes[i];
            var popup = jQuery('.popup', jQuery("[name='${_name}']").parent()).css('opacity', 0);
            popup.css({top: -30, left: opts.leftShifts[i], display: 'block' })
                    .animate({ top: '-=' + distance + 'px',  opacity: 0.8}, time, 'swing', function() {
            });

            if (!opts.msiePop && $.browser.msie) {
                jQuery(popup).remove();
            }
        });
    }


    // Get the parent form
    var form = $("[name='${_name}']").parents("form");
    var action = form.attr("action");
    var validate = function(e) {
        var v = $("input[name='${_name}']").val();
        var validateAction = #{jsAction @Validation.validate(':formAction', ':name', ':value') /};
        var name = "${_name}";
        var popup = jQuery('.popup', jQuery("[name='${_name}']").parent()).css('opacity', 0);

        popup.animate({ opacity: 0 }, 12, 'swing', function () {

            popup.css('display', 'none');
        });
        $.get(validateAction({formAction: action, value: v, name: name}), function(response) {
            // Callback method
            if ('${_useText}' == 'true') {
                $('#${n}-error').text(response);
            } else {
                var opts = {
                    distances : [40,40,100],
                    leftShifts : [60,110,110],
                    bubbleTimes : [500,500,500],
                    hideDelays : [0,0,0],
                    bubbleWidths : [200,350,350],
                    bubbleImagesPath : "/public/images/skins/classic",
                    msieFix : true,
                    msiePop : true
                };
                if (response) {
                    $('#${n}-error').codaBubble(opts, "<b style='color:red'>" + response + "</b>");
                }
            }

        });
    };
    $("[name='${_name}']").blur(validate);


</script>
